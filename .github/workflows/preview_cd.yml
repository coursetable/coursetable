name: Preview CD

on:
  pull_request:
    branches: [master]
    paths:
      - 'frontend/**'
      - '.github/workflows/preview_cd.yml'

jobs:
  frontend-build-and-deploy:
    name: Frontend Build and Deploy
    environment:
      name: Preview
      url: ${{steps.deploy.outputs.DEPLOY_URL }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      - name: Encode URL Branch
        id: encode_url_branch
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            return "${{ github.head_ref }}".replace(/[^0-9a-zA-Z\-]+/g, "-").slice(-17).match(/[0-9a-zA-Z][a-zA-Z0-9 \-\.]+$/)
      - name: Install Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Install Dependencies
        run: bun install --frozen-lockfile
      - name: Expose GitHub environment as shell variables
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}
        run: |
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          to_envs() { jq -r "to_entries[] | \"\(.key)<<$EOF\n\(.value)\n$EOF\n\""; }
          echo "$SECRETS_CONTEXT" | to_envs >> $GITHUB_ENV
          unset DB_NAME
      - name: Build Frontend
        run: cd frontend && bun run build
      - name: Install Wrangler CLI
        run: bun install --global wrangler
      - name: Deploy to Cloudflare Pages
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_KEY_VALUE }}
        run: |
          wrangler pages deploy frontend/build --project-name=coursetable --branch=${{ steps.encode_url_branch.outputs.result }}-preview | tee deploy.log
          DEPLOY_URL=$(grep -oP 'https://[^\s]+' deploy.log | head -n 1)
          echo "DEPLOY_URL=${DEPLOY_URL}" >> $GITHUB_OUTPUT

  comment:
    name: Preview Comment
    runs-on: ubuntu-latest

    needs: [frontend-build-and-deploy]

    permissions:
      pull-requests: write

    steps:
      - name: Encode URL Branch
        id: encode_url_branch
        uses: actions/github-script@v7
        with:
          result-encoding: string
          script: |
            return "${{ github.head_ref }}".replace(/[^0-9a-zA-Z\-]+/g, "-").slice(-25).match(/[0-9a-zA-Z][a-zA-Z0-9 \-\.]+$/)
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            Thanks for your pull request! The preview of your changes is available at https://${{ steps.encode_url_branch.outputs.result }}-preview.coursetable.pages.dev
