services:
  api:
    ports:
      - '4096:4096'
      - '3001:3001'
    volumes:
      - ../api/static:/app/static
      - ../api/src:/app/src
    build:
      args:
        - HOT_RELOAD=true
    environment:
      OVERWRITE_CATALOG: ${OVERWRITE_CATALOG:-'false'}

    depends_on:
      mysql:
        condition: service_healthy

  mysql:
    build: ./mysql
    image: coursetable/mysql:latest
    container_name: mysql
    command: --default-authentication-plugin=mysql_native_password --log-warnings
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD?password}
    ports:
      - '3306:3306'
    healthcheck:
      test:
        [
          'CMD',
          '/usr/local/bin/healthcheck.sh',
          '--su-mysql',
          '--connect',
          '--innodb_initialized',
        ]
      interval: 0.5s
      timeout: 10s
      retries: 60

  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    depends_on:
      - mysql
    environment:
      PMA_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD?password}
    ports:
      - '8081:80'
